# 博客网站更新指南

## 📁 项目结构说明

```
/Users/wangjiaqiao/Desktop/blog/
├── client/                     # 前端代码
├── server/                     # 后端代码
│   ├── src/                   # 源代码
│   ├── data/                  # 数据文件
│   │   └── articles.json      # 博客文章数据
│   ├── documents/             # 📋 文档文件夹 (主要使用)
│   │   └── *.typ              # Typst 文档文件
│   │   └── *.md               # Markdown 文档文件
│   ├── uploads/               # 上传文件夹 (系统用)
│   │   └── documents/         # ⚠️ 系统生成的文件，请勿手动修改
│   └── compiled/              # 编译输出文件夹 (系统用)
└── 网站更新指南.md             # 本文件
```

## 🎯 文档路径说明

### 主要文档目录（您需要关注的）
- **📋 `/server/documents/`**
  - **用途**: 存放您的文档文件
  - **支持格式**: `.typ` (Typst), `.md` (Markdown)
  - **操作**: 直接添加、修改、删除文件

### 系统目录（自动管理，请勿手动修改）
- **⚙️ `/server/uploads/documents/`**
  - **用途**: 系统上传功能的临时存储
  - **注意**: 由系统自动管理，请勿手动修改

- **⚙️ `/server/compiled/`**
  - **用途**: Typst 文件编译后的 PDF 存储
  - **注意**: 系统自动生成和清理

## 📝 如何更新网站内容

### 1. 添加新的博客文章

**方法一: 直接编辑数据文件**
```bash
# 编辑文章数据文件
/server/data/articles.json
```

在文件中添加新的文章对象：
```json
{
  "id": "unique-id-here",
  "title": "文章标题",
  "content": "文章内容 (支持 Markdown 或 Typst 格式)",
  "category": "blog|skills|projects",
  "tags": ["标签1", "标签2"],
  "author": "作者名",
  "excerpt": "文章摘要",
  "images": [],
  "createdAt": "2025-01-01T00:00:00.000Z",
  "updatedAt": "2025-01-01T00:00:00.000Z"
}
```

### 2. 添加新的文档

**步骤:**
1. 将文档文件放入 `/server/documents/` 文件夹
2. 支持的文件格式:
   - `.typ` - Typst 文档（会自动编译为 PDF 预览）
   - `.md` - Markdown 文档

**示例:**
```bash
# 复制文档到正确位置
cp ~/Desktop/我的文档.typ /Users/wangjiaqiao/Desktop/blog/server/documents/
```

### 3. 启动开发服务器

```bash
# 进入项目目录
cd /Users/wangjiaqiao/Desktop/blog

# 启动开发服务器
npm run dev
```

服务器启动后:
- 前端: http://localhost:3001
- 后端: http://localhost:5001

## 🔄 文档自动处理

### Typst 文档 (.typ)
- ✅ 自动编译为 PDF
- ✅ 提供 PDF 预览
- ✅ 显示源代码
- ✅ 支持下载

### Markdown 文档 (.md)
- ✅ 自动渲染为 HTML
- ✅ 支持代码高亮
- ✅ 支持下载

## 🚀 部署到生产环境

```bash
# 构建项目
npm run build

# 启动生产服务器
npm start
```

## 📋 日常维护检查清单

### 每次添加内容时:
- [ ] 确认文件放在正确的目录 (`/server/documents/`)
- [ ] 检查文件名没有特殊字符
- [ ] 测试文档在网站上正常显示
- [ ] 确认 PDF 编译正常（对于 .typ 文件）

### 定期清理:
- [ ] 清理 `/server/compiled/` 中的临时 PDF 文件
- [ ] 检查 `/server/uploads/` 中是否有不必要的文件

## ⚠️ 重要注意事项

1. **只在 `/server/documents/` 中添加文档文件**
2. **不要手动修改 `/server/uploads/` 中的文件**
3. **备份 `/server/data/articles.json` 文件**
4. **Typst 文件需要有效的语法才能正确编译**

## 🛠️ 故障排除

### Typst 文档不能编译
```bash
# 检查 Typst 是否安装
typst --version

# 手动测试编译
typst compile /path/to/document.typ
```

### 文档不显示
1. 检查文件是否在正确目录
2. 检查文件权限
3. 重启开发服务器

### 服务器启动失败
```bash
# 检查端口是否被占用
lsof -i :3001
lsof -i :5001

# 清理 node_modules 并重新安装
rm -rf node_modules
npm install
```

## 📞 技术支持

如果遇到问题：
1. 检查控制台错误信息
2. 查看服务器日志
3. 确认文件路径和权限正确

## 🔧 高级维护操作

### 数据库维护
```bash
# 文章数据完整性检查
node -e "
const data = require('./server/data/articles.json');
data.forEach((article, index) => {
  if (!article.id || !article.title || !article.content) {
    console.log(\`问题文章 \${index}: \${article.title || 'Unknown'}\`);
  }
});
"

# 清理重复文章ID
node -e "
const fs = require('fs');
const data = require('./server/data/articles.json');
const ids = new Set();
const cleaned = data.filter(article => {
  if (ids.has(article.id)) {
    console.log(\`移除重复文章: \${article.title}\`);
    return false;
  }
  ids.add(article.id);
  return true;
});
fs.writeFileSync('./server/data/articles.json', JSON.stringify(cleaned, null, 2));
"
```

### 文件系统维护
```bash
# 检查孤立文件（没有被文章引用的图片）
find server/uploads/images -name "*.jpg" -o -name "*.png" -o -name "*.webp" | while read file; do
  basename_file=$(basename "$file")
  if ! grep -r "$basename_file" server/data/articles.json > /dev/null; then
    echo "孤立文件: $file"
  fi
done

# 清理过期的编译文件（7天前的）
find server/compiled -name "*.pdf" -mtime +7 -delete

# 检查文档目录权限
ls -la server/documents/
chmod 755 server/documents/
chmod 644 server/documents/*.typ 2>/dev/null || true
```

### 性能优化
```bash
# 压缩图片文件（需要安装 imagemagick）
find server/uploads/images -name "*.jpg" -exec mogrify -quality 85 {} \;
find server/uploads/images -name "*.png" -exec mogrify -quality 95 {} \;

# 检查大文件
find server/ -size +10M -ls

# 监控内存使用
ps aux | grep node | awk '{print $4, $11}' | sort -nr
```

### 自动化脚本

#### 创建备份脚本
```bash
# 创建 backup.sh
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="$HOME/backups/blog"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

echo "开始备份博客数据..."

# 备份文章数据
cp server/data/articles.json "$BACKUP_DIR/articles_$DATE.json"

# 备份文档文件
cp -r server/documents "$BACKUP_DIR/documents_$DATE"

# 备份上传文件
cp -r server/uploads "$BACKUP_DIR/uploads_$DATE"

# 创建压缩包
cd "$BACKUP_DIR"
tar -czf "blog_backup_$DATE.tar.gz" articles_$DATE.json documents_$DATE uploads_$DATE
rm -rf articles_$DATE.json documents_$DATE uploads_$DATE

echo "备份完成: $BACKUP_DIR/blog_backup_$DATE.tar.gz"

# 清理30天前的备份
find "$BACKUP_DIR" -name "blog_backup_*.tar.gz" -mtime +30 -delete
EOF

chmod +x backup.sh
```

#### 创建健康检查脚本
```bash
# 创建 health_check.sh
cat > health_check.sh << 'EOF'
#!/bin/bash

echo "=== 博客系统健康检查 ==="
echo "时间: $(date)"
echo

# 检查进程
echo "1. 检查服务进程:"
if pgrep -f "npm run dev" > /dev/null; then
    echo "✅ 开发服务器正在运行"
else
    echo "❌ 开发服务器未运行"
fi

# 检查端口
echo -e "\n2. 检查端口状态:"
if lsof -i:3001 > /dev/null 2>&1; then
    echo "✅ 前端端口 3001 正常"
else
    echo "❌ 前端端口 3001 未监听"
fi

if lsof -i:5001 > /dev/null 2>&1; then
    echo "✅ 后端端口 5001 正常"
else
    echo "❌ 后端端口 5001 未监听"
fi

# 检查磁盘空间
echo -e "\n3. 检查磁盘空间:"
df -h server/ | tail -1 | awk '{print "磁盘使用率:", $5}'

# 检查文件权限
echo -e "\n4. 检查关键目录权限:"
ls -ld server/documents server/uploads server/data

# 检查 Typst 安装
echo -e "\n5. 检查 Typst:"
if command -v typst > /dev/null; then
    echo "✅ Typst 已安装: $(typst --version)"
else
    echo "❌ Typst 未安装"
fi

# 检查文章数据
echo -e "\n6. 检查数据文件:"
if [ -f server/data/articles.json ]; then
    ARTICLE_COUNT=$(node -e "console.log(require('./server/data/articles.json').length)")
    echo "✅ 文章数据正常，共 $ARTICLE_COUNT 篇文章"
else
    echo "❌ 文章数据文件丢失"
fi

echo -e "\n=== 检查完成 ==="
EOF

chmod +x health_check.sh
```

## 📋 维护检查清单

### 每日检查
- [ ] 运行健康检查脚本：`./health_check.sh`
- [ ] 查看开发服务器日志是否有错误
- [ ] 检查网站是否正常访问

### 每周检查
- [ ] 备份重要数据：`./backup.sh`
- [ ] 清理临时编译文件：`rm -rf server/compiled/*`
- [ ] 检查磁盘空间使用情况
- [ ] 更新系统包：`npm outdated`

### 每月检查
- [ ] 完整系统备份
- [ ] 检查并清理孤立文件
- [ ] 性能优化：压缩图片文件
- [ ] 安全检查：查看异常访问日志

### 发布前检查
- [ ] 运行完整测试：`npm test`（如果有测试）
- [ ] 检查所有链接是否正常工作
- [ ] 验证 Typst 文档编译正常
- [ ] 确认暗色模式显示正常
- [ ] 测试响应式设计在不同设备上的表现

## 🚨 紧急恢复程序

### 系统崩溃恢复
1. **停止所有服务**：`pkill -f "npm run dev"`
2. **检查端口占用**：`lsof -i :3001 && lsof -i :5001`
3. **强制清理进程**：`kill -9 $(lsof -ti:3001,5001)`
4. **恢复数据**：从最近备份恢复 `articles.json`
5. **重新安装依赖**：`rm -rf node_modules && npm install`
6. **重新启动**：`npm run dev`

### 数据损坏恢复
```bash
# 1. 立即停止服务
pkill -f "npm run dev"

# 2. 备份损坏文件
cp server/data/articles.json server/data/articles.json.corrupted

# 3. 从备份恢复
cp ~/backups/blog/articles_YYYYMMDD.json server/data/articles.json

# 4. 验证数据完整性
node -e "console.log(require('./server/data/articles.json').length + ' articles loaded')"

# 5. 重启服务
npm run dev
```

---

**最后更新**: 2025年9月22日
**版本**: 2.0
**维护指南版本**: v2.0.0